#!/bin/bash
# Validates commit messages follow Conventional Commits format

commit_msg_file="$1"
commit_msg=$(cat "$commit_msg_file")

# Skip merge commits
if echo "$commit_msg" | grep -qE "^Merge"; then
    exit 0
fi

# Conventional Commits pattern: type(scope): subject
pattern="^(feat|fix|docs|style|refactor|test|chore)(\(.+\))?: .{1,72}"

if ! echo "$commit_msg" | grep -qE "$pattern"; then
    echo ""
    echo "❌ ERROR: Commit message doesn't follow Conventional Commits format"
    echo ""
    echo "Expected format:"
    echo "  <type>(<scope>): <subject>"
    echo ""
    echo "Example:"
    echo "  feat(airline-service): add flight booking endpoint"
    echo "  fix(domain): ensure airline entity immutability"
    echo "  test(use-cases): add booking validation tests"
    echo ""
    echo "Valid types: feat, fix, docs, style, refactor, test, chore"
    echo ""
    echo "Your commit message:"
    echo "  $commit_msg"
    echo ""
    exit 1
fi

# Check subject line length (first line only)
first_line=$(echo "$commit_msg" | head -n 1)
if [ ${#first_line} -gt 72 ]; then
    echo ""
    echo "⚠️  WARNING: Commit subject line is too long (${#first_line} characters)"
    echo "Recommended: 72 characters or less"
    echo ""
fi

exit 0
