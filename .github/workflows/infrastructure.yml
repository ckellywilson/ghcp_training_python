name: Infrastructure - Deploy Azure Resources

on:
  push:
    branches: [main, master]
    paths:
      - 'infrastructure/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - deploy
          - validate
          - what-if
        default: 'validate'

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Validate Bicep templates
        working-directory: ./infrastructure/bicep
        run: |
          az bicep build --file main.bicep
          echo "✅ Bicep validation successful"
  
  what-if:
    needs: validate
    if: github.event.inputs.action == 'what-if' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Run what-if
        id: what-if
        working-directory: ./infrastructure/bicep
        run: |
          az deployment sub what-if \
            --location eastus \
            --template-file main.bicep \
            --parameters environments/${{ steps.set-env.outputs.ENVIRONMENT }}.bicepparam \
            --result-format FullResourcePayloads \
            > what-if-output.txt
          cat what-if-output.txt
      
      - name: Comment PR with what-if results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('./infrastructure/bicep/what-if-output.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Infrastructure What-If Results\n\n\`\`\`\n${output}\n\`\`\``
            });
  
  deploy:
    needs: validate
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'deploy') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Deploy infrastructure
        working-directory: ./infrastructure/bicep
        run: |
          az deployment sub create \
            --location eastus \
            --template-file main.bicep \
            --parameters environments/${{ steps.set-env.outputs.ENVIRONMENT }}.bicepparam \
            --name "deploy-${{ steps.set-env.outputs.ENVIRONMENT }}-${{ github.run_number }}"
      
      - name: Output deployment results
        run: |
          echo "✅ Infrastructure deployment successful"
          echo "Environment: ${{ steps.set-env.outputs.ENVIRONMENT }}"
